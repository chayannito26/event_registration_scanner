<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Registration Scanner</title>
        <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/x-icon" href="favicon.ico"  />
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- html5-qrcode library for QR code scanning -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Custom styles for better UX */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #qr-reader {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
            width: 100%;
            min-height: 220px;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
        }
        #qr-reader video, #qr-reader canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        /* Style for the scan region line */
        #html5-qrcode-anchor-scan-type-change {
            display: none;
        }
        .scan-log-item {
            transition: background-color 0.3s ease;
        }
        .claimed-label {
            position: relative;
            cursor: pointer;
            display: inline-block;
            width: 24px;
            height: 24px;
        }
        .claimed-label input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .claimed-label .checkbox-ui {
            position: absolute;
            top: 0;
            left: 0;
            height: 24px;
            width: 24px;
            background-color: #e2e8f0; /* slate-200 */
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.25rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    /* compact attendee parts list */
    .attendee-parts { display: flex; flex-wrap: wrap; gap: 6px; }
    .attendee-parts .part-item { background: #fff; border: 1px solid #e6edf3; padding: 6px 8px; border-radius: 999px; display:flex; align-items:center; gap:6px; font-size:12px; }
        .claimed-label:hover .checkbox-ui {
            background-color: #cbd5e1; /* slate-300 */
        }
        .claimed-label input:checked + .checkbox-ui {
            background-color: #22c55e; /* green-500 */
        }
        .claimed-label .checkbox-ui::after {
            content: "";
            position: absolute;
            display: none;
            left: 8px;
            top: 4px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
        .claimed-label input:checked + .checkbox-ui::after {
            display: block;
        }
        /* Simple modal for messages */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto max-w-2xl p-4 space-y-6">

        <!-- Header -->
        <header class="text-center">
            <h1 class="text-3xl font-bold text-slate-900">Event Registration Scanner</h1>
            <p class="text-slate-600 mt-1">Scan QR codes and manage attendees.</p>
        </header>

        <!-- QR Scanner and Attendee Section (combined for compact UI) -->
        <section id="scanner-section" class="bg-white p-3 rounded-lg shadow-sm">
            <h2 class="text-lg font-semibold mb-3 border-b pb-2">Scanner & Attendee</h2>
            <!-- start button remains available for users who prefer it -->
            <button id="start-scan-btn" class="hidden w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg transition duration-300">
                <i class="fas fa-camera mr-2"></i>Start Scanning
            </button>

            <!-- Container becomes responsive two-column: left=reader, right=attendee -->
            <div id="qr-reader-container" class="hidden mt-2 grid grid-cols-1 md:grid-cols-2 gap-3 items-start">
                <div class="flex flex-col gap-2">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex-1 mr-2">
                            <label id="camera-selector-label" for="camera-selector" class="block text-sm font-medium text-slate-700 mb-1 hidden">Select Camera</label>
                            <select id="camera-selector" class="w-full p-2 border border-slate-300 rounded-lg hidden"></select>
                        </div>
                        <div>
                            <button id="switch-camera-btn" class="hidden bg-slate-200 hover:bg-slate-300 text-slate-700 py-1 px-2 rounded-lg">Switch</button>
                        </div>
                    </div>
                    <div id="qr-reader" class="w-full mx-auto border border-dashed border-slate-200 rounded-md overflow-hidden" style="min-height:220px;">
                    </div>
                    <div id="scan-status" class="mt-2 text-center text-sm font-medium p-2 rounded-lg bg-slate-100 text-slate-700">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading registration data...
                    </div>
                </div>

                <!-- Attendee Information (moved into scanner card to keep UI in one frame) -->
                <div id="attendee-info-section" class="hidden bg-slate-50 p-2 rounded-md">
                    <div class="text-sm text-slate-600 mb-2">Scanned Attendee</div>
                    <div id="attendee-details" class="space-y-2 text-sm"></div>
                </div>
            </div>
        </section>

        <!-- Manual Search Section -->
        <section id="search-section" class="bg-white p-4 rounded-lg shadow-sm">
            <h2 class="text-lg font-semibold mb-3 border-b pb-2">Manual Lookup</h2>
            <div class="relative">
                <input type="text" id="search-input" placeholder="Search by name or ID..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>
            <div id="search-results" class="mt-2"></div>
        </section>

        <!-- Scan Log Section -->
        <section id="scan-log-section" class="bg-white p-4 rounded-lg shadow-sm">
            <h2 class="text-lg font-semibold mb-3 border-b pb-2">Recent Scans</h2>
            <div class="flex items-center justify-between mb-3 gap-3">
                <div class="flex items-center gap-2">
                    <label for="scan-log-max" class="text-sm text-slate-600">Keep last</label>
                    <input id="scan-log-max" type="number" min="1" max="500" class="w-20 p-1 border border-slate-300 rounded" />
                    <span class="text-sm text-slate-600">entries</span>
                </div>
                <div>
                    <button id="clear-scan-log-btn" class="bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-1 px-3 rounded">Clear Log</button>
                </div>
            </div>
            <div id="scan-log" class="space-y-2 max-h-60 overflow-y-auto">
                <p id="scan-log-placeholder" class="text-slate-500 text-center">No scans yet.</p>
            </div>
        </section>

    </div>

    <!-- Modal for notifications -->
    <div id="modal" class="modal-overlay hidden">
        <div class="modal-content shadow-lg">
            <p id="modal-message" class="text-lg"></p>
            <button id="modal-close-btn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full transition duration-300">Close</button>
        </div>
    </div>


    <script>
            // --- Firebase Configuration ---
            const firebaseConfig = {
            apiKey: "AIzaSyDsI5v9okHOdxbEw8k8hXwzPzZMpDrirbM",
            authDomain: "chayannito-26.firebaseapp.com",
            projectId: "chayannito-26",
            storageBucket: "chayannito-26.firebasestorage.app",
            messagingSenderId: "127749935084",
            appId: "1:127749935084:web:8bf6df50ce2cbc96cdbac9",
            measurementId: "G-CRHHT66GTQ"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const firestore = firebase.firestore();


            // --- Password Protection ---
            const PASSWORD = "bulbul123"; // Set your password here
            const PASSWORD_KEY = "eventScannerAuth";

            function showPasswordModal() {
                const modal = document.getElementById('modal');
                const modalMessage = document.getElementById('modal-message');
                const modalCloseBtn = document.getElementById('modal-close-btn');
                modalMessage.innerHTML = `<input type="password" id="password-input" placeholder="Enter password..." class="w-full p-2 border border-slate-300 rounded-lg mb-4" autofocus><br><span id="password-error" class="text-red-500 text-sm"></span>`;
                modalCloseBtn.textContent = "Submit";
                modal.classList.remove('hidden');
                modalCloseBtn.onclick = function() {
                    const input = document.getElementById('password-input').value;
                    const error = document.getElementById('password-error');
                    if (input === PASSWORD) {
                        localStorage.setItem(PASSWORD_KEY, "1");
                        modal.classList.add('hidden');
                        location.reload();
                    } else {
                        error.textContent = "Incorrect password.";
                    }
                };
            }

            function isAuthenticated() {
                return localStorage.getItem(PASSWORD_KEY) === "1";
            }

            document.addEventListener('DOMContentLoaded', () => {
                if (!isAuthenticated()) {
                    showPasswordModal();
                    return;
                }
            // --- DOM Element References ---
            const startScanBtn = document.getElementById('start-scan-btn');
            const qrReaderContainer = document.getElementById('qr-reader-container');
            const qrReaderElement = document.getElementById('qr-reader');
            const scanStatusElement = document.getElementById('scan-status');
            const attendeeInfoSection = document.getElementById('attendee-info-section');
            const attendeeDetailsElement = document.getElementById('attendee-details');
            const scanLogElement = document.getElementById('scan-log');
            const searchInput = document.getElementById('search-input');
            const searchResultsElement = document.getElementById('search-results');
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // --- App State ---
            let registrationData = [];
            let claimedData = {}; // To store claimed parts (local + remote)
            let html5QrCode = null;
            let lastScannedId = null;
            let availableCameras = [];
            let currentCameraId = null;
            let scanHistory = [];
            const SCAN_HISTORY_KEY = 'scanHistory';
            const SCAN_LOG_MAX_KEY = 'scanLogMax';
            const CAMERA_ID_KEY = 'selectedCameraId';
            const SCANNER_OPEN_KEY = 'scannerOpen';
            const REGISTRANTS_CACHE_KEY = 'registrantsCache';
            const CLAIMED_CACHE_KEY = 'claimedCache';
            const CLAIMED_PENDING_KEY = 'claimedPendingSync';
            const DEFAULT_MAX_SCAN_ENTRIES = 20;
            let maxScanEntries = DEFAULT_MAX_SCAN_ENTRIES;

            // --- Utility Functions ---
            // Vibration patterns for tactile feedback
            const VIB_PATTERNS = {
                success: [200, 50, 200], // two short pulses
                notFound: [400],         // one long pulse
                invalid: [100, 50, 100]  // quick double pulse
            };

            function doVibrate(pattern) {
                if (navigator && typeof navigator.vibrate === 'function') {
                    try {
                        navigator.vibrate(pattern);
                    } catch (e) {
                        // ignore vibration errors silently
                    }
                }
            }
            function showModal(message) {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            }

            function hideModal() {
                modal.classList.add('hidden');
            }
            
            function updateScanStatus(text, iconClass, bgClass) {
                if (text === 'Ready to scan') {
                    scanStatusElement.classList.add('hidden');
                } else {
                    scanStatusElement.innerHTML = `<i class="${iconClass} mr-2"></i>${text}`;
                    scanStatusElement.className = `mt-4 text-center font-medium p-3 rounded-lg ${bgClass} text-white transition-all duration-300`;
                    scanStatusElement.classList.remove('hidden');
                }
            }

            function displayAttendeeInfo(attendee) {
                attendeeInfoSection.classList.remove('hidden');
                const attendeeClaimedParts = claimedData[attendee.registration_id] || [];
                // render parts as compact chips with checkboxes on the left for space efficiency
                let partsHtml = attendee.parts_available.map(part => {
                    const isClaimed = attendeeClaimedParts.includes(part);
                    return `<label class="part-item" style="user-select:none;"><input type=\"checkbox\" class=\"claim-checkbox\" data-attendee-id=\"${attendee.registration_id}\" data-part=\"${part}\" ${isClaimed ? 'checked' : ''} style=\"margin:0;\"><span>${part}</span></label>`;
                }).join('');

                // Robust referred_by resolution
                let refName = '';
                if (attendee.referred_by) {
                    let ref = registrationData.find(r => r.registration_id === attendee.referred_by);
                    if (!ref && attendee.referred_by.length > 0) {
                        ref = registrationData.find(r => r.roll === attendee.referred_by);
                    }
                    if (!ref && attendee.referred_by.length > 0) {
                        ref = registrationData.find(r => r.name.toLowerCase() === attendee.referred_by.toLowerCase());
                    }
                    if (ref) {
                        refName = ref.name + ` <span class='text-xs text-slate-400'>(ID: ${ref.registration_id})</span>`;
                    } else {
                        refName = `<span class='text-slate-400'>${attendee.referred_by} (unresolved)</span>`;
                    }
                } else {
                    refName = '<span class="text-slate-400">None</span>';
                }

                attendeeDetailsElement.innerHTML = `
                        <div class="flex items-center gap-3 mb-2">
                            <img src="${attendee.photo && attendee.photo.trim() ? attendee.photo : `https://chayannito26.com/college-students/images/${attendee.roll || 'placeholder'}.jpg`}" alt="Attendee Photo" class="w-16 h-16 object-cover rounded-full border border-slate-200 bg-slate-100" onerror="this.onerror=null;this.src='https://chayannito26.com/college-students/images/placeholder.jpg';">
                        </div>
                    <div>
                        <div class="attendee-parts">${partsHtml}</div>
                        <div class="mt-2">
                            <p class="text-lg font-semibold truncate">${attendee.name}</p>
                            <p class="text-xs text-slate-500">ID: ${attendee.registration_id}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs text-slate-700 mt-2">
                            <div><span class="font-semibold">Roll:</span> ${attendee.roll}</div>
                            <div><span class="font-semibold">Reg:</span> ${attendee.registration_date}</div>
                            <div><span class="font-semibold">Paid:</span> <span class="text-green-700 font-bold">${attendee.paid}</span></div>
                            <div><span class="font-semibold">Ref:</span> ${refName}</div>
                        </div>
                        ${attendee.revoked ? `<div class='mt-2 flex items-center gap-2 p-2 bg-red-100 border border-red-400 rounded text-xs'><i class='fas fa-ban text-red-600'></i><span class='text-red-700 font-bold'>Revoked</span></div>` : ''}
                    </div>
                `;
                document.querySelectorAll('.claim-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', handleClaimToggle);
                });
            }

            function addToScanLog(logData, found) {
                // Remove placeholder if present
                const placeholder = document.getElementById('scan-log-placeholder');
                if (placeholder) placeholder.remove();

                // Build and prepend the visual log item
                        // Register service worker for PWA
                        if ('serviceWorker' in navigator) {
                            window.addEventListener('load', function() {
                                navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                                }, function(err) {
                                    console.log('ServiceWorker registration failed: ', err);
                                });
                            });
                        }
                const logItem = document.createElement('div');
                logItem.className = 'scan-log-item p-2 rounded-lg border';
                const now = new Date();
                const timeString = now.toLocaleTimeString();

                if (found) {
                    const attendeeClaimedParts = claimedData[logData.registration_id] || [];
                    const claimedCount = attendeeClaimedParts.length;
                    const totalCount = (logData.parts_available || []).length;
                    logItem.classList.add('bg-green-50', 'border-green-200');
                    logItem.innerHTML = `<div class=\"flex items-center justify-between\"><p class=\"font-semibold\">${logData.name}</p><span class=\"text-xs text-slate-400\">${timeString}</span></div><p class=\"text-xs text-slate-600\">Claimed ${claimedCount}/${totalCount}</p>`;
                } else {
                    let statusText = logData.reason === 'Invalid' ? 'Invalid QR' : 'Not Found';
                    logItem.classList.add('bg-red-50', 'border-red-200');
                    logItem.innerHTML = `<div class=\"flex items-center justify-between\"><p class=\"font-semibold\">Scanned: ${logData.id}</p><span class=\"text-xs text-slate-400\">${timeString}</span></div><p class=\"text-xs text-slate-600\">${statusText}</p>`;
                }
                scanLogElement.prepend(logItem);

                // Add to in-memory history and persist
                const entry = {
                    time: new Date().toISOString(),
                    found: !!found,
                    payload: found ? { id: logData.registration_id || '', name: logData.name || '', claimedParts: claimedData[logData.registration_id] || [], registeredParts: logData.parts_available || [] } : { id: logData.id || '', reason: logData.reason }
                };
                scanHistory.unshift(entry);
                // Enforce max size
                if (scanHistory.length > maxScanEntries) scanHistory.splice(maxScanEntries);
                try { localStorage.setItem(SCAN_HISTORY_KEY, JSON.stringify(scanHistory)); } catch (e) { console.warn('Could not save scan history', e); }
            }

            function renderScanHistory() {
                const log = document.getElementById('scan-log');
                log.innerHTML = '';
                if (!scanHistory || scanHistory.length === 0) {
                    log.innerHTML = '<p id="scan-log-placeholder" class="text-slate-500 text-center">No scans yet.</p>';
                    return;
                }
                scanHistory.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'scan-log-item p-2 rounded-lg border ' + (item.found ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200');
                    const timeString = new Date(item.time).toLocaleTimeString();
                    if (item.found) {
                        const claimedCount = (item.payload.claimedParts || []).length;
                        const totalCount = (item.payload.registeredParts || []).length;
                        div.innerHTML = `<p class="font-semibold">${item.payload.name || item.payload.id}</p><p class="text-sm text-slate-600">Status: Claimed ${claimedCount}/${totalCount} parts. <span class="text-xs text-slate-400 float-right">${timeString}</span></p>`;
                    } else {
                        const statusText = (item.payload.reason === 'Invalid') ? 'Invalid QR Code' : 'Not Registered';
                        div.innerHTML = `<p class="font-semibold">Scanned: ${item.payload.id}</p><p class="text-sm text-slate-600">Status: ${statusText} <span class="text-xs text-slate-400 float-right">${timeString}</span></p>`;
                    }
                    log.appendChild(div);
                });
            }

            function loadScanHistoryFromStorage() {
                try {
                    const raw = localStorage.getItem(SCAN_HISTORY_KEY);
                    if (raw) scanHistory = JSON.parse(raw) || [];
                } catch (e) {
                    console.warn('Failed to load scan history', e);
                    scanHistory = [];
                }
            }

            function clearScanHistory() {
                scanHistory = [];
                try { localStorage.removeItem(SCAN_HISTORY_KEY); } catch (e) { console.warn('Could not clear scan history', e); }
                renderScanHistory();
            }

            function enableAppFeatures() {
                startScanBtn.classList.remove('hidden'); // Show the start button
                updateScanStatus('Ready to scan', 'fas fa-qrcode', 'bg-blue-500');
            }

            // --- Event Handlers ---
            function handleClaimToggle(event) {
                const { attendeeId, part } = event.target.dataset;
                const isChecked = event.target.checked;
                // Update local claimedData
                let localParts = claimedData[attendeeId] || [];
                if (isChecked) {
                    if (!localParts.includes(part)) localParts.push(part);
                } else {
                    localParts = localParts.filter(p => p !== part);
                }
                claimedData[attendeeId] = localParts;
                // Persist locally
                try {
                    const cache = JSON.parse(localStorage.getItem(CLAIMED_CACHE_KEY) || '{}');
                    cache[attendeeId] = localParts;
                    localStorage.setItem(CLAIMED_CACHE_KEY, JSON.stringify(cache));
                } catch (e) {}
                // Mark for sync if offline
                if (!navigator.onLine) {
                    let pending = JSON.parse(localStorage.getItem(CLAIMED_PENDING_KEY) || '[]');
                    pending.push({ attendeeId, part, isChecked, ts: Date.now() });
                    localStorage.setItem(CLAIMED_PENDING_KEY, JSON.stringify(pending));
                } else {
                    // Sync immediately if online
                    const docRef = firestore.collection('claimedParts').doc(attendeeId);
                    if (isChecked) {
                        docRef.set({ parts: firebase.firestore.FieldValue.arrayUnion(part) }, { merge: true });
                    } else {
                        docRef.set({ parts: firebase.firestore.FieldValue.arrayRemove(part) }, { merge: true });
                    }
                }
            }

            function handleSearch() {
                const query = searchInput.value.toLowerCase().trim();
                searchResultsElement.innerHTML = '';
                if (query.length < 2) return;

                const results = registrationData.filter(a => a.name.toLowerCase().includes(query) || a.registration_id.toLowerCase().includes(query));
                if (results.length > 0) {
                    searchResultsElement.innerHTML = results.map(attendee => `
                        <div class="p-2 border-b hover:bg-slate-100 cursor-pointer search-result-item" data-attendee-id="${attendee.registration_id}">
                            <p class="font-medium">${attendee.name}</p><p class="text-sm text-slate-500">${attendee.registration_id}</p>
                        </div>`).join('');
                    
                    document.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            const attendee = registrationData.find(a => a.registration_id === e.currentTarget.dataset.attendeeId);
                            if (attendee) {
                                displayAttendeeInfo(attendee);
                                searchInput.value = '';
                                searchResultsElement.innerHTML = '';
                            }
                        });
                    });
                } else {
                    searchResultsElement.innerHTML = '<p class="p-2 text-slate-500">No results found.</p>';
                }
            }

            // --- QR Scanner Logic ---
            function startScanner() {
                if (html5QrCode && html5QrCode._isScanning) return;
                html5QrCode = new Html5Qrcode("qr-reader");
                const cameraConfig = currentCameraId ? { deviceId: { exact: currentCameraId } } : { facingMode: "environment" };
                html5QrCode.start(
                    cameraConfig,
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    () => {} // onScanFailure - do nothing
                ).catch(err => {
                    console.error('Scanner start error', err);
                    updateScanStatus('Camera permission denied or not available.', 'fas fa-exclamation-triangle', 'bg-red-500');
                });
            }

            async function stopScanner() {
                if (html5QrCode) {
                    try {
                        await html5QrCode.stop();
                    } catch (e) {
                        console.warn('Error stopping scanner', e);
                    }
                    html5QrCode.clear();
                    html5QrCode = null;
                    // mark scanner as closed
                    try { localStorage.removeItem(SCANNER_OPEN_KEY); } catch (e) {}
                }
            }

            async function enumerateCameras() {
                if (!Html5Qrcode.getCameras) return;
                try {
                    const devices = await Html5Qrcode.getCameras();
                    availableCameras = devices || [];
                    const selector = document.getElementById('camera-selector');
                    const label = document.getElementById('camera-selector-label');
                    const switchBtn = document.getElementById('switch-camera-btn');
                    selector.innerHTML = '';

                    // Helper: extract first integer from a string (used to compare numeric camera ids)
                    function extractNumber(str) {
                        if (!str) return NaN;
                        const m = String(str).match(/\d+/);
                        return m ? parseInt(m[0], 10) : NaN;
                    }

                    // Heuristic to detect back-facing camera from label
                    function isBackDevice(dev) {
                        const l = (dev.label || '').toLowerCase();
                        return l.includes('back') || l.includes('rear') || l.includes('environment');
                    }

                    if (availableCameras.length > 0) {
                        // populate selector options
                        availableCameras.forEach(cam => {
                            const opt = document.createElement('option');
                            opt.value = cam.id || cam.deviceId || cam.label;
                            opt.textContent = cam.label || cam.id || cam.deviceId || 'Camera';
                            selector.appendChild(opt);
                        });

                        if (availableCameras.length > 1) {
                            selector.classList.remove('hidden');
                            label.classList.remove('hidden');
                            switchBtn.classList.remove('hidden');

                            // Primary: pick cameras whose label indicates 'back' or 'rear'
                            const backCandidates = availableCameras.filter(isBackDevice);
                            let chosen = null;

                            if (backCandidates.length > 0) {
                                // If numeric ids are present, choose the lowest numeric id
                                backCandidates.sort((a, b) => {
                                    const na = extractNumber(a.id || a.deviceId || a.label);
                                    const nb = extractNumber(b.id || b.deviceId || b.label);
                                    if (isNaN(na) && isNaN(nb)) return 0;
                                    if (isNaN(na)) return 1;
                                    if (isNaN(nb)) return -1;
                                    return na - nb;
                                });
                                chosen = backCandidates[0];
                            } else {
                                // Fallback: pick the lowest numeric id among devices that don't explicitly say 'front'
                                const numericDevices = availableCameras.filter(d => !isNaN(extractNumber(d.id || d.deviceId || d.label)));
                                if (numericDevices.length > 0) {
                                    numericDevices.sort((a, b) => extractNumber(a.id || a.deviceId || a.label) - extractNumber(b.id || b.deviceId || b.label));
                                    const filtered = numericDevices.filter(d => { const l = (d.label || '').toLowerCase(); return !l.includes('front'); });
                                    chosen = filtered.length ? filtered[0] : numericDevices[0];
                                } else {
                                    // Last resort: just pick the first available camera
                                    chosen = availableCameras[0];
                                }
                            }

                            currentCameraId = chosen.id || chosen.deviceId || chosen.label;
                            if (selector.options.length) selector.value = currentCameraId;
                        } else {
                            // single camera available
                            selector.classList.add('hidden');
                            label.classList.add('hidden');
                            switchBtn.classList.add('hidden');
                            currentCameraId = availableCameras[0] ? (availableCameras[0].id || availableCameras[0].deviceId) : null;
                        }
                    } else {
                        selector.classList.add('hidden');
                        label.classList.add('hidden');
                        switchBtn.classList.add('hidden');
                        currentCameraId = null;
                    }
                } catch (e) {
                    console.warn('Could not enumerate cameras', e);
                }
            }

            function handleInvalidScan(scannedText) {
                updateScanStatus(`Invalid QR Code`, 'fas fa-times-circle', 'bg-red-500');
                attendeeInfoSection.classList.add('hidden');
                addToScanLog({ id: scannedText, reason: 'Invalid' }, false);
                doVibrate(VIB_PATTERNS.invalid);
                setTimeout(() => { lastScannedId = null; }, 3000);
            }

            function onScanSuccess(decodedText) {
                if (decodedText === lastScannedId) return;
                lastScannedId = decodedText;
                // provide distinct vibration feedback depending on result

                const qrPrefix = "https://chayannito26.com/verify/";
                if (!decodedText.startsWith(qrPrefix)) {
                    handleInvalidScan(decodedText);
                    return;
                }

                const encodedPart = decodedText.substring(qrPrefix.length);

                function rot13(str) {
                    return str.replace(/[a-zA-Z]/g, function (c) {
                        return String.fromCharCode(
                            c.charCodeAt(0) +
                            (c.toLowerCase() < 'n' ? 13 : -13)
                        );
                    });
                }

                let attendeeId;
                try {
                    // Reverse the string
                    const reversed = encodedPart.split("").reverse().join("");
                    // Apply ROT13
                    const rotDecoded = rot13(reversed);
                    // Base64 decode
                    attendeeId = atob(rotDecoded);
                } catch (e) {
                    handleInvalidScan(decodedText);
                    return;
                }


                const attendee = registrationData.find(a => a.registration_id === attendeeId);
                if (attendee) {
                    updateScanStatus(`Found: ${attendee.name}`, 'fas fa-check-circle', 'bg-green-500');
                    displayAttendeeInfo(attendee);
                    addToScanLog(attendee, true);
                    doVibrate(VIB_PATTERNS.success);
                } else {
                    updateScanStatus(`Not found: ${attendeeId}`, 'fas fa-times-circle', 'bg-red-500');
                    attendeeInfoSection.classList.add('hidden');
                    addToScanLog({ id: attendeeId, reason: 'Not Found' }, false);
                    doVibrate(VIB_PATTERNS.notFound);
                }
                
                setTimeout(() => { lastScannedId = null; }, 3000);
            }

            // --- Initialization ---
            async function syncClaimedPending() {
                if (!navigator.onLine) return;
                let pending = [];
                try { pending = JSON.parse(localStorage.getItem(CLAIMED_PENDING_KEY) || '[]'); } catch (e) {}
                if (!pending.length) return;
                for (const item of pending) {
                    const docRef = firestore.collection('claimedParts').doc(item.attendeeId);
                    if (item.isChecked) {
                        await docRef.set({ parts: firebase.firestore.FieldValue.arrayUnion(item.part) }, { merge: true });
                    } else {
                        await docRef.set({ parts: firebase.firestore.FieldValue.arrayRemove(item.part) }, { merge: true });
                    }
                }
                localStorage.removeItem(CLAIMED_PENDING_KEY);
            }

            async function init() {
                searchInput.addEventListener('input', handleSearch);
                if (isAuthenticated()) {
                    modalCloseBtn.addEventListener('click', hideModal);
                }
                startScanBtn.addEventListener('click', () => {
                    startScanBtn.remove();
                    qrReaderContainer.classList.remove('hidden');
                    updateScanStatus('Ready to scan', 'fas fa-qrcode', 'bg-blue-500');
                    try { localStorage.setItem(SCANNER_OPEN_KEY, '1'); } catch (e) {}
                    enumerateCameras().then(() => startScanner());
                });
                const cameraSelector = document.getElementById('camera-selector');
                const switchCameraBtn = document.getElementById('switch-camera-btn');
                cameraSelector.addEventListener('change', async (e) => {
                    currentCameraId = e.target.value;
                    try { localStorage.setItem(CAMERA_ID_KEY, currentCameraId); } catch (err) {}
                    await stopScanner();
                    startScanner();
                });
                switchCameraBtn.addEventListener('click', async () => {
                    if (!availableCameras || availableCameras.length < 2) return;
                    const idx = availableCameras.findIndex(c => (c.id || c.deviceId) === currentCameraId);
                    const next = (idx + 1) % availableCameras.length;
                    currentCameraId = availableCameras[next].id || availableCameras[next].deviceId;
                    if (cameraSelector.options.length) cameraSelector.value = currentCameraId;
                    try { localStorage.setItem(CAMERA_ID_KEY, currentCameraId); } catch (err) {}
                    await stopScanner();
                    startScanner();
                });
                // --- Scan history: load and wire controls ---
                const maxInput = document.getElementById('scan-log-max');
                const clearBtn = document.getElementById('clear-scan-log-btn');
                try {
                    const savedMax = parseInt(localStorage.getItem(SCAN_LOG_MAX_KEY), 10);
                    if (!isNaN(savedMax) && savedMax > 0) maxScanEntries = savedMax;
                } catch (e) { }
                maxInput.value = maxScanEntries;
                await enumerateCameras();
                try {
                    const savedCam = localStorage.getItem(CAMERA_ID_KEY);
                    if (savedCam) {
                        currentCameraId = savedCam;
                        const selector = document.getElementById('camera-selector');
                        if (selector && selector.options.length) {
                            const opt = Array.from(selector.options).find(o => o.value === savedCam);
                            if (opt) selector.value = savedCam;
                        }
                    }
                } catch (e) { }
                loadScanHistoryFromStorage();
                if (scanHistory.length > maxScanEntries) scanHistory.splice(maxScanEntries);
                renderScanHistory();
                maxInput.addEventListener('change', (e) => {
                    const v = parseInt(e.target.value, 10);
                    if (!isNaN(v) && v > 0) {
                        maxScanEntries = Math.min(500, v);
                        localStorage.setItem(SCAN_LOG_MAX_KEY, String(maxScanEntries));
                        if (scanHistory.length > maxScanEntries) {
                            scanHistory.splice(maxScanEntries);
                            localStorage.setItem(SCAN_HISTORY_KEY, JSON.stringify(scanHistory));
                            renderScanHistory();
                        }
                    }
                });
                clearBtn.addEventListener('click', () => {
                    if (confirm('Clear scan history? This cannot be undone.')) {
                        clearScanHistory();
                    }
                });
                try {
                    const wasOpen = localStorage.getItem(SCANNER_OPEN_KEY) === '1';
                    if (wasOpen) {
                        startScanBtn.remove();
                        qrReaderContainer.classList.remove('hidden');
                        updateScanStatus('Ready to scan', 'fas fa-qrcode', 'bg-blue-500');
                        startScanner();
                    }
                } catch (e) {}
                // --- Offline/Online Data Loading ---
                async function loadRegistrants() {
                    // Try local cache first
                    let localData = null;
                    try {
                        localData = JSON.parse(localStorage.getItem(REGISTRANTS_CACHE_KEY) || 'null');
                    } catch (e) {}
                    if (localData && Array.isArray(localData) && localData.length) {
                        registrationData = localData;
                        return true;
                    }
                    // Fallback to network
                    try {
                        const response = await fetch('https://chayannito26.com/verify/registrants.json');
                        if (!response.ok) throw new Error('Network response was not ok');
                        registrationData = await response.json();
                        localStorage.setItem(REGISTRANTS_CACHE_KEY, JSON.stringify(registrationData));
                        return true;
                    } catch (e) {
                        updateScanStatus('Error loading registrants. Offline?', 'fas fa-exclamation-triangle', 'bg-red-500');
                        return false;
                    }
                }
                async function loadClaimed() {
                    // Try local cache first
                    let localClaimed = {};
                    try {
                        localClaimed = JSON.parse(localStorage.getItem(CLAIMED_CACHE_KEY) || '{}');
                    } catch (e) {}
                    claimedData = localClaimed;
                    // If online, sync with Firestore
                    if (navigator.onLine) {
                        try {
                            const querySnapshot = await firestore.collection('claimedParts').get();
                            querySnapshot.forEach((doc) => {
                                claimedData[doc.id] = doc.data().parts || [];
                            });
                            localStorage.setItem(CLAIMED_CACHE_KEY, JSON.stringify(claimedData));
                        } catch (e) {
                            // If Firestore fails, keep local
                        }
                    }
                }
                // Listen for online/offline events
                window.addEventListener('online', async () => {
                    updateScanStatus('Online. Syncing...', 'fas fa-cloud-upload-alt', 'bg-blue-500');
                    await syncClaimedPending();
                    await loadClaimed();
                    updateScanStatus('Ready to scan', 'fas fa-qrcode', 'bg-blue-500');
                });
                window.addEventListener('offline', () => {
                    updateScanStatus('Offline mode. Changes will sync when online.', 'fas fa-wifi', 'bg-yellow-500');
                });
                // Initial load
                const registrantsLoaded = await loadRegistrants();
                await loadClaimed();
                // Listen for changes in claimed parts (online only)
                if (navigator.onLine) {
                    firestore.collection('claimedParts').onSnapshot((snapshot) => {
                        let changes = [];
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' || change.type === 'modified') {
                                claimedData[change.doc.id] = change.doc.data().parts || [];
                            } else if (change.type === 'removed') {
                                delete claimedData[change.doc.id];
                            }
                            changes.push({type: change.type, id: change.doc.id, parts: change.doc.data().parts || []});
                        });
                        if (changes.length > 0) {
                            localStorage.setItem(CLAIMED_CACHE_KEY, JSON.stringify(claimedData));
                        }
                        // If attendee info is currently displayed, refresh it
                        const displayedAttendeeId = document.querySelector('.claim-checkbox')?.dataset.attendeeId;
                        if (displayedAttendeeId) {
                            const attendee = registrationData.find(a => a.registration_id === displayedAttendeeId);
                            if (attendee) {
                                displayAttendeeInfo(attendee);
                            }
                        }
                    });
                }
                enableAppFeatures();
            }
            init();
        });
    </script>
</body>
</html>
